# Services Intercommunication

![Service intercommunication diagram](media/services-intercommunication.png)

**EventGrid** is the primary mechanism used in the design for inter-service 
communication.

Each new satellite message that arrives from remote devices generates a 
`NewReturnMessage` event containing the message payload and metadata.  Event 
subscriptions route these into **DeviceToCloudBridge** and the orchestrator 
**OtaCommandResponse** to process or ignore as appropriate.

**CloudToDeviceBridge** publishes a `CommandRequest` when it detects a desired 
property change in IoT Central.  This is picked up by the **OtaCommandStart** 
for orchestration.

Sources such as the orchestrator (**OtaCommandSubmit**) can trigger a 
`NewForwardSubmission` event including data payload which is received by 
**MessageForwardSubmit** in the satellite messaging function, which in turn 
generates the over-the-air message and publishes an event.  The 
`NewForwardMessage` event is subsequently picked up by **OtaCommandSending** and 
used to monitor delivery progress through the orchestrator.

The `ForwardMessageStateChange` event is picked up by **OtaCommandDelivery** to 
progress through the orchestrator which conditionally waits for a subsequent 
`NewReturnMessage` (**OtaCommandResponse**) to generate an `OtaCommandResponse` 
event and complete orchestration.

`ApiOutage` and `ApiRecovery` events may be generated by the satellite messaging 
function, which are picked up by the **IdpApiNotifications** Logic App to 
generate an email for escalation.